<!doctype html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>掌握核心技术之Golang | 周小猪</title>
    <meta property="og:title" content="掌握核心技术之Golang - 周小猪">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-01-13T15:33:14&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-01-13T15:33:14&#43;08:00'>
        
    <meta name="Keywords" content="elastic search">
    <meta name="description" content="掌握核心技术之Golang">
        
    <meta name="author" content="周小猪">
    <meta property="og:url" content="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bgolang/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://ganodermaking.github.io/">
                        周小猪
                    </a>
                
                <p class="description">The world has changed a little because of me.</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://ganodermaking.github.io/">首页</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">掌握核心技术之Golang</h1>
        </header>
        <date class="post-meta meta-date">
            2021年1月13日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/golang'>Golang</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>不要通过共享内存来通信，而应该通过通信来共享内存。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Go is an open source programming language that makes it easy to build simple, reliable, and efficient software.
</code></pre></div><blockquote>
<p>Go是一种开源编程语言，它使构建简单、可靠和高效的软件变得容易。</p>
</blockquote>
<p>主要通过一下几种场景进行比较</p>
<ul>
<li>MPG模型</li>
<li>跨平台</li>
<li>反射</li>
<li>错误处理机制</li>
<li>泛型</li>
<li>协程</li>
<li>sync</li>
<li>垃圾回收</li>
<li>pprof</li>
<li>slice 、map、chan</li>
</ul>
<h2 id="mpg模型">MPG模型</h2>
<p>在传统的并发中起很多线程只会加大CPU和内存的开销，太多的线程会大量的消耗计算机硬件资源，造成并发量的瓶颈。</p>
<ul>
<li>M指的是Machine，一个M直接关联了一个内核线程。</li>
<li>P指的是Processor，代表了M所需的上下文环境，也是处理用户级代码逻辑的处理器。</li>
<li>G指的是Goroutine，其实本质上也是一种轻量级的线程。

        <img class="mx-auto" alt="" src="/images/MPG%e6%9e%b6%e6%9e%84%e5%9b%be.png" />   
    </li>
</ul>
<h2 id="跨平台">跨平台</h2>
<ul>
<li>编译可执行程序，在不同平台安装Java虚拟机（JVM），来实现跨平台。</li>
<li>通过不同环境变量，编译运行在不同平台的可执行程序。</li>
</ul>
<blockquote>
<p>在运行时，Java平台中的Java解释器对这些字节码进行解释执行，执行过程中需要的类在联接阶段被载入到运行环境中。</p>
</blockquote>
<p>基于docker scratch最小镜像的dockerfile</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">FROM scratch
ADD app /
CMD [&#34;/app&#34;]
</code></pre></div><p>Mac下编译Linux和Windows 64位可执行程序</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span>amd64 go build .
CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> GOOS<span style="color:#f92672">=</span>windows GOARCH<span style="color:#f92672">=</span>amd64 go build .
</code></pre></div><p>Linux下编译Mac和Windows 64位可执行程序</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> GOOS<span style="color:#f92672">=</span>darwin GOARCH<span style="color:#f92672">=</span>amd64 go build .
CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> GOOS<span style="color:#f92672">=</span>windows GOARCH<span style="color:#f92672">=</span>amd64 go build .
</code></pre></div><h2 id="面向对象">面向对象</h2>
<p>Go语言不是一门面向对象编程语言，使用组合的方式，通过接口和结构体模拟面向对象。</p>
<h3 id="接口">接口</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Animal</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Sleep</span>()
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Mouse</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMouse</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">Animal</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Mouse</span>{
		<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
	}
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Mouse</span>) <span style="color:#a6e22e">Sleep</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;正在睡&#34;</span>)
}
</code></pre></div><h3 id="用组合代替继承">用组合代替继承</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Animal</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Name</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Animal</span>) <span style="color:#a6e22e">Sleep</span>() {
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">Name</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;正在睡&#34;</span>)
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Mouse</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Animal</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMouse</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Mouse</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Mouse</span>{
		<span style="color:#a6e22e">Animal</span>: <span style="color:#a6e22e">Animal</span>{
			<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
		},
	}
}
</code></pre></div><h2 id="反射">反射</h2>
<p>反射就是动态的获取变量类型信息和值信息的机制。应用场景如下：</p>
<ul>
<li>序列化，例如：<code>google.golang.org/grpc</code></li>
<li>数据库ORM，例如：<code>github.com/jinzhu/gorm</code></li>
<li>配置文件解析，例如：<code>github.com/BurntSushi/toml</code></li>
</ul>
<h3 id="一对变量进行处理">一、对变量进行处理</h3>
<h4 id="获取变量的类型信息">获取变量的类型信息</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> = <span style="color:#e6db74">&#34;hello world&#34;</span>

<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">x</span>)
<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;type of a is:%v\n&#34;</span>, <span style="color:#a6e22e">t</span>)

<span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>()
<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">k</span> {
<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Int</span>:
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;a is int\n&#34;</span>)
<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">String</span>:
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;a is string\n&#34;</span>)
}
</code></pre></div><h4 id="获取变量的值信息">获取变量的值信息</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> = <span style="color:#e6db74">&#34;hello world&#34;</span>

<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#a6e22e">x</span>)
<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;type of a is:%v\n&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>())

<span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Kind</span>()
<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">k</span> {
<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Int</span>:
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;a is int, store value is:%d\n&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Int</span>())
<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">String</span>:
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;a is string, store value is:%s\n&#34;</span>, <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">String</span>())
}
</code></pre></div><h4 id="对值进行赋值操作">对值进行赋值操作</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">x</span> = <span style="color:#ae81ff">3.14</span>

<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>) <span style="color:#75715e">// 这里传地址
</span><span style="color:#75715e"></span><span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Elem</span>().<span style="color:#a6e22e">SetFloat</span>(<span style="color:#ae81ff">6.28</span>)
</code></pre></div><h3 id="二对结构体进行处理">二、对结构体进行处理</h3>
<h4 id="获取结构体的字段">获取结构体的字段</h4>
<p>可以通过 NumField() 获取所有结构体字段的数目、进而遍历，通过Field()方法获取字段的信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Student</span>{
    <span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;BigOrange&#34;</span>,
    <span style="color:#a6e22e">Sex</span>:   <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">Age</span>:   <span style="color:#ae81ff">10</span>,
    <span style="color:#a6e22e">Score</span>: <span style="color:#ae81ff">80.1</span>,
}

<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#a6e22e">x</span>)
<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>()

<span style="color:#75715e">// NumFiled()获取字段数，v.Field(i)可以取得下标位置的字段信息，返回的是一个Value类型的值
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">NumField</span>(); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
    <span style="color:#a6e22e">field</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Field</span>(<span style="color:#a6e22e">i</span>)
    <span style="color:#75715e">// 打印字段的名称、类型以及值
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Field</span>(<span style="color:#a6e22e">i</span>).<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Type</span>().<span style="color:#a6e22e">Kind</span>(), <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Interface</span>())
}
</code></pre></div><h4 id="对结构体内的字段进行赋值操作">对结构体内的字段进行赋值操作</h4>
<pre><code>x := Student{
    Name:  &quot;BigOrange&quot;,
    Sex:   1,
    Age:   10,
    Score: 80.1,
}

v := reflect.ValueOf(&amp;x) // 这里传地址

v.Elem().Field(0).SetString(&quot;ChangeName&quot;) // 通过索引赋值
v.Elem().FieldByName(&quot;Score&quot;).SetFloat(99.9) // 通过字段名称赋值
</code></pre><h4 id="获取结构体里面的方法">获取结构体里面的方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Student</span>{
    <span style="color:#a6e22e">Name</span>:  <span style="color:#e6db74">&#34;BigOrange&#34;</span>,
    <span style="color:#a6e22e">Sex</span>:   <span style="color:#ae81ff">1</span>,
    <span style="color:#a6e22e">Age</span>:   <span style="color:#ae81ff">10</span>,
    <span style="color:#a6e22e">Score</span>: <span style="color:#ae81ff">80.1</span>,
}

<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>()

<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">NumMethod</span>(); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
    <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Method</span>(<span style="color:#a6e22e">i</span>)
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Name</span>, <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Type</span>)
}
</code></pre></div><h4 id="获取结构体里tag">获取结构体里tag</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Student</span>{
    <span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;BigOrange&#34;</span>,
}

<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">x</span>)
<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">Type</span>()

<span style="color:#a6e22e">field0</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Elem</span>().<span style="color:#a6e22e">Field</span>(<span style="color:#ae81ff">0</span>) <span style="color:#75715e">// 通过索引获取字段
</span><span style="color:#75715e">// field0, _ := t.Elem().FieldByName(&#34;Name&#34;) // 通过字段名称获取字段
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">field0</span>.<span style="color:#a6e22e">Tag</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;json&#34;</span>))
</code></pre></div><h2 id="错误处理机制">错误处理机制</h2>
<p>golang中一个协程发生panic而没有被捕获，会导致整个程序终止。java中一个线程发生异常，只要其主线程不终止，那么整个程序还是运行的。</p>
<p>通过defer和recover捕获异常：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span> () {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> recover(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
    }
}()
</code></pre></div><h3 id="捕获panic异常">捕获panic异常</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">router</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">New</span>()
	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">LoggerWithFormatter</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">param</span> <span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">LogFormatterParams</span>) <span style="color:#66d9ef">string</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s - [%s] \&#34;%s %s %s %d %s \&#34;%s\&#34; %s\&#34;\n&#34;</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">ClientIP</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">TimeStamp</span>.<span style="color:#a6e22e">Format</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">RFC1123</span>),
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">Method</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">Path</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">Proto</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">StatusCode</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">Latency</span>,
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">Request</span>.<span style="color:#a6e22e">UserAgent</span>(),
			<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">ErrorMessage</span>,
		)
	}))
	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Recovery</span>()) <span style="color:#75715e">// 捕获和处理异常
</span><span style="color:#75715e"></span>
	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/ping&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gin</span>.<span style="color:#a6e22e">Context</span>) {
		<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#ae81ff">200</span>, <span style="color:#e6db74">&#34;pong&#34;</span>)
	})

	<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;:5000&#34;</span>)
}
</code></pre></div><h3 id="自定义错误">自定义错误</h3>
<p>errors.New()方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">text</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">errorString</span>{<span style="color:#a6e22e">text</span>}
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">errorString</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">errorString</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">s</span>
}
</code></pre></div><h2 id="泛型">泛型</h2>
<p>最早在Go 1.17版本支持，目前可通过如下满足一部分场景。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Sortable</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">Less</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span>
	<span style="color:#a6e22e">Swap</span>(<span style="color:#66d9ef">int</span>, <span style="color:#66d9ef">int</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">bubbleSort</span>(<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">Sortable</span>) {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">Len</span>(); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">j</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">j</span> &lt; <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">Len</span>()<span style="color:#f92672">-</span><span style="color:#a6e22e">i</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">j</span><span style="color:#f92672">++</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">j</span>) {
				<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">j</span>, <span style="color:#a6e22e">j</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
			}
		}
	}
}

<span style="color:#75715e">// 实现接口的整型切片
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IntArr</span> []<span style="color:#66d9ef">int</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">IntArr</span>) <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">array</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">IntArr</span>) <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>] &lt; <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>]
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">IntArr</span>) <span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>]
}

<span style="color:#75715e">// 实现接口的字符串，按照长度排序
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">StringArr</span> []<span style="color:#66d9ef">string</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">StringArr</span>) <span style="color:#a6e22e">Len</span>() <span style="color:#66d9ef">int</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">array</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">StringArr</span>) <span style="color:#a6e22e">Less</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">return</span> len(<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>]) &lt; len(<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>])
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">array</span> <span style="color:#a6e22e">StringArr</span>) <span style="color:#a6e22e">Swap</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">j</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>] = <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">j</span>], <span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>]
}

<span style="color:#75715e">// 测试
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">intArray1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">IntArr</span>{<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>}
	<span style="color:#a6e22e">bubbleSort</span>(<span style="color:#a6e22e">intArray1</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">intArray1</span>)

	<span style="color:#a6e22e">stringArray1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">StringArr</span>{<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#e6db74">&#34;i&#34;</span>, <span style="color:#e6db74">&#34;am&#34;</span>, <span style="color:#e6db74">&#34;go&#34;</span>, <span style="color:#e6db74">&#34;lang&#34;</span>}
	<span style="color:#a6e22e">bubbleSort</span>(<span style="color:#a6e22e">stringArray1</span>)
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">stringArray1</span>)
}
</code></pre></div><h2 id="协程">协程</h2>
<p>协程是一种用户态的轻量级线程。不要以共享内存的方式来通信，相反，要通过通信来共享内存。</p>
<h3 id="信道通信">信道通信</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
	<span style="color:#a6e22e">done</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)

	<span style="color:#75715e">// 写
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> {
			<span style="color:#75715e">// select语句，每个case必须是一个通信操作，要么是发送要么是接收，随机执行一个可运行的case。
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">select</span> {
			<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rand</span>.<span style="color:#a6e22e">Int</span>(): <span style="color:#75715e">// 发送消息
</span><span style="color:#75715e"></span>			}
		}
	}()

	<span style="color:#75715e">// 读
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">5</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;rand number = &#34;</span>, <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>)
		}
		<span style="color:#a6e22e">done</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span> <span style="color:#75715e">// 发送终止信号并返回
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span>
	}()

	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">done</span> <span style="color:#75715e">// 接收到终止信号时退出主程序
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="消息队列">消息队列</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">2</span>)

	<span style="color:#75715e">// 消费者
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">m</span>)
		}
	}()

	<span style="color:#75715e">// 消费者
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">m</span>)
		}
	}()

	<span style="color:#75715e">// 生产者
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">i</span>
		}
	}()

	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
}
</code></pre></div><h3 id="超时处理">超时处理</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>, <span style="color:#ae81ff">1</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>)
		<span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
	}()

	<span style="color:#66d9ef">select</span> {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>:
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">res</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">After</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>):
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;timeout&#34;</span>)
	}
}
</code></pre></div><h3 id="slice并发不安全">slice并发不安全</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">c</span> <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		}()
	}

	<span style="color:#75715e">// 等待关闭channel
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
		close(<span style="color:#a6e22e">c</span>)
	}()

    <span style="color:#75715e">// for range等待channel，直到被关闭
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> []<span style="color:#66d9ef">int</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span> {
		<span style="color:#a6e22e">s</span> = append(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">i</span>)
	}
}
</code></pre></div><h2 id="sync">sync</h2>
<h3 id="syncatomic">sync.Atomic</h3>
<p>sync/atomic 可以在并发场景下对变量进行非侵入式的操作。可以保证并发安全，虽然使用sync.Mutex可以实现，但是使用sync/atomic不仅是轻量级的，而且代码也更加简洁。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">count</span> <span style="color:#f92672">:=</span> int64(<span style="color:#ae81ff">0</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">AddInt64</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">count</span>, <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// 原子操作
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
		}(<span style="color:#a6e22e">i</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><h3 id="syncmutex">sync.Mutex</h3>
<p>互斥锁和读写互斥锁。</p>
<h4 id="解决map并发不安全">解决map并发不安全</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">int</span>]<span style="color:#66d9ef">int</span>)

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#a6e22e">i</span>
			<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
		}
	}()

	<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
			<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">m</span>[<span style="color:#a6e22e">i</span>])
			<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
		}
	}()
}
</code></pre></div><h4 id="解决slice并发不安全">解决slice并发不安全</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span> []<span style="color:#66d9ef">int</span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">appendValue</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
	<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#a6e22e">s</span> = append(<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">i</span>)
	<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">appendValue</span>(<span style="color:#a6e22e">i</span>)
	}
}
</code></pre></div><blockquote>
<p>在读多写少的环境中，可以优先使用读写互斥锁（sync.RWMutex），它比互斥锁更加高效。</p>
</blockquote>
<h3 id="synconce">sync.Once</h3>
<p>sync.Once是Golang package中使方法只执行一次的对象实现。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">once</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Once</span>
	<span style="color:#a6e22e">flag</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">bool</span>)

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
			<span style="color:#a6e22e">once</span>.<span style="color:#a6e22e">Do</span>(<span style="color:#66d9ef">func</span>() {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;only once&#34;</span>)
			})
			<span style="color:#a6e22e">flag</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">true</span>
		}()
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">flag</span>
	}
}
</code></pre></div><h3 id="syncpool">sync.Pool</h3>
<p>sync.Pool是一个临时的对象池，适用于储存一些会在goroutine间共享的临时对象，减少内存的分配。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bufPool</span> = <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Pool</span> {
	<span style="color:#a6e22e">New</span>: <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">interface</span>{} {
		<span style="color:#66d9ef">return</span> new(<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
	},
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>()  {
	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufPool</span>.<span style="color:#a6e22e">Get</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>)
	<span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">Reset</span>()
	<span style="color:#a6e22e">buf</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#e6db74">&#34;hello&#34;</span>)
	<span style="color:#a6e22e">bufPool</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">buf</span>)
}
</code></pre></div><blockquote>
<p>sync.Pool缓存的期限只是两次gc之间这段时间</p>
</blockquote>
<h3 id="syncwaitgroup">sync.WaitGroup</h3>
<p>阻塞等待所有任务完成之后再继续执行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wg</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#ae81ff">1</span>)
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">i</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Done</span>()
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">i</span>)
		}(<span style="color:#a6e22e">i</span>)
	}
	<span style="color:#a6e22e">wg</span>.<span style="color:#a6e22e">Wait</span>()
}
</code></pre></div><h2 id="垃圾回收">垃圾回收</h2>
<h3 id="回收对象">回收对象</h3>
<p>垃圾回收（Automatic Garbage Collection），一个自动回收堆内存的工具。</p>
<p>程序中会使用到两种内存，分别为堆（Heap）和栈（Stack），而 GC 不负责回收栈中的内存。主要原因是栈是一块专用内存，专门为了函数执行而准备的，存储着函数中的局部变量以及调用栈。除此以外，栈中的数据都有一个特点——简单。比如局部变量就不能被函数外访问，所以这块内存用完就可以直接释放。</p>
<blockquote>
<p>主流的两类垃圾回收算法有两种，分别是追踪式垃圾回收算法和引用计数法。</p>
</blockquote>
<h3 id="触发gc的机制">触发GC的机制</h3>
<ol>
<li>在申请内存的时候，检查当前已分配的内存是否大于上次GC后的内存的2倍</li>
<li>监控线程发现上次GC的时间已经超过两分钟</li>
<li>手动：runtime.gc()</li>
</ol>
<h3 id="三色标记">三色标记</h3>
<ul>
<li>灰色：对象已被标记，但这个对象包含的子对象未标记</li>
<li>黑色：对象已被标记，且这个对象包含的子对象也已标记</li>
<li>白色：对象未被标记</li>
</ul>
<p>GC步骤：</p>
<ol>
<li>首先创建三个集合：白、灰、黑。</li>
<li>将所有对象放入白色集合中。</li>
<li>然后从根节点开始遍历所有对象，把遍历到的对象从白色集合放入灰色集合。</li>
<li>之后遍历灰色集合，将灰色对象引用的对象从白色集合放入灰色集合，之后将此灰色对象放入黑色集合</li>
<li>重复4直到灰色中无任何对象</li>
<li>通过write-barrier检测对象有变化，重复以上操作</li>
<li>收集所有白色对象（垃圾）</li>
</ol>
<h3 id="标记清扫法">标记清扫法</h3>
<p>最开始所有的标记位都是 0，如果发现对象是可达的就会置为 1，一步步下去就会呈现一个类似树状的结果。等标记的步骤完成后，会将未被标记的对象统一清理，再次把所有的标记位设置成 0 方便下次清理。</p>
<h3 id="pprof">pprof</h3>
<p>pprof 是用于可视化和分析性能分析数据的工具</p>
<ul>
<li>CPU性能分析</li>
<li>内存性能优化</li>
</ul>
<h2 id="slice-mapchan">slice 、map、chan</h2>
<ul>
<li>slice本身是一个结构体，而不是一个指针，其底层实现是指向数组的指针。</li>
<li>map返回的一个指针，底层实现是hashmap，并采用链地址方法解决hash冲突的。</li>
</ul>
<blockquote>
<p>向切片新增一个元素时，若该切片容量已满，会首先根据切片容量进行判断，小于1024字节扩容为原有容量的2倍，大于1024字节扩容为原有容量的1.25倍。</p>
</blockquote>
<p>作为参数的比较：</p>
<ul>
<li>函数内部可以修改slice(指向同一地址)，append操作不可以(返回一个新的slice)；slice内部实现是指向数组的指针。</li>
<li>函数内部可以修改map；makemap的返回值为一个hmap类型的指针。</li>
<li>函数内部可以修改chan；makechan的返回值为一个hchan类型的指针。</li>
</ul>
<blockquote>
<p>函数参数都是值传递，传入函数内部会对其拷贝一份。</p>
</blockquote>
<h3 id="slice-append操作">slice append操作</h3>
<ul>
<li>如果添加数据后没有超过原始容量，新的slice对象和原始slice共用底层数组，len数据会变化，cap数据不变；</li>
<li>添加数据后超过容量那就会扩容，重新分配一个新的底层数组，然后拷贝底层数组数据过去，那么append后产生的新slice对象和原始的slice就没有任何关系。</li>
</ul>
<h3 id="slice扩容机制">slice扩容机制</h3>
<p>扩容规则：</p>
<ul>
<li>如果期望的最小容量大于原始的两倍容量时，那么新的容量就是等于期望的最小容量；</li>
<li>不满足第一种情况，那么判断原slice的底层数组元素长度是不是小于1024。小于1024，新容量是原来的两倍；大于等于1024 ，新容量是原来的1.25倍。</li>
</ul>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Belasticsearch/">掌握核心技术之ElasticSearch</a></li>
        
        <li><a href="/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Beureka/">掌握核心技术之Eureka</a></li>
        
        <li><a href="/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bjava/">掌握核心技术之Java</a></li>
        
        <li><a href="/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bmongodb/">掌握核心技术之MongoDB</a></li>
        
        <li><a href="/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bmysql/">掌握核心技术之MySQL</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/golang'>Golang</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="http://ganodermaking.github.io/">周小猪 By 周小猪</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>






                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://ganodermaking.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Belasticsearch/" title="掌握核心技术之ElasticSearch">掌握核心技术之ElasticSearch</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Beureka/" title="掌握核心技术之Eureka">掌握核心技术之Eureka</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bgolang/" title="掌握核心技术之Golang">掌握核心技术之Golang</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bjava/" title="掌握核心技术之Java">掌握核心技术之Java</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bmongodb/" title="掌握核心技术之MongoDB">掌握核心技术之MongoDB</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bmysql/" title="掌握核心技术之MySQL">掌握核心技术之MySQL</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Brabbitmq/" title="掌握核心技术之RabbitMQ">掌握核心技术之RabbitMQ</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bredis/" title="掌握核心技术之Redis">掌握核心技术之Redis</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bzookeeper/" title="掌握核心技术之Zookeeper">掌握核心技术之Zookeeper</a>
    </li>
    
    <li>
        <a href="http://ganodermaking.github.io/post/%E6%8E%8C%E6%8F%A1%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B9%8Bkafka/" title="掌握核心技术之微服务">掌握核心技术之微服务</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://ganodermaking.github.io/categories/golang/">Golang (1)</a></li>
    
    <li><a href="http://ganodermaking.github.io/categories/java/">Java (1)</a></li>
    
    <li><a href="http://ganodermaking.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件 (8)</a></li>
    
    <li><a href="http://ganodermaking.github.io/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 (1)</a></li>
    
    <li><a href="http://ganodermaking.github.io/categories/%E7%AE%97%E6%B3%95/">算法 (1)</a></li>
    
    <li><a href="http://ganodermaking.github.io/categories/%E7%BD%91%E7%BB%9C/">网络 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://ganodermaking.github.io/tags/elasticsearch/">ElasticSearch</a>
    
    <a href="http://ganodermaking.github.io/tags/eureka/">Eureka</a>
    
    <a href="http://ganodermaking.github.io/tags/golang/">Golang</a>
    
    <a href="http://ganodermaking.github.io/tags/java/">Java</a>
    
    <a href="http://ganodermaking.github.io/tags/kafka/">Kafka</a>
    
    <a href="http://ganodermaking.github.io/tags/mongodb/">MongoDB</a>
    
    <a href="http://ganodermaking.github.io/tags/mysql/">MySQL</a>
    
    <a href="http://ganodermaking.github.io/tags/rabbitmq/">RabbitMQ</a>
    
    <a href="http://ganodermaking.github.io/tags/redis/">Redis</a>
    
    <a href="http://ganodermaking.github.io/tags/zookeeper/">Zookeeper</a>
    
    <a href="http://ganodermaking.github.io/tags/%E7%AE%97%E6%B3%95/">算法</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://ganodermaking.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>